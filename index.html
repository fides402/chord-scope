<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChordScope - Analizzatore di Accordi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0a0a0f; --surface: #14141f; --primary: #00ffc8; --secondary: #ff6b9d; --text: #e8e8f0; --text-muted: #6b6b80; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 24px; }
        header { text-align: center; margin-bottom: 32px; }
        .logo { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 2rem; color: var(--primary); text-shadow: 0 0 20px rgba(0, 255, 200, 0.4); }
        .logo span { color: var(--secondary); }
        .subtitle { color: var(--text-muted); margin-top: 8px; }
        .upload-zone { background: var(--surface); border: 2px dashed rgba(0, 255, 200, 0.3); border-radius: 16px; padding: 48px; text-align: center; cursor: pointer; transition: all 0.3s ease; max-width: 600px; margin: 0 auto; }
        .upload-zone:hover { border-color: var(--primary); background: rgba(0, 255, 200, 0.05); }
        .upload-zone.hidden { display: none; }
        .file-input { display: none; }
        .results { max-width: 800px; margin: 0 auto; display: none; }
        .results.active { display: block; }
        .section { background: var(--surface); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
        .section-title { font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: var(--primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid rgba(0, 255, 200, 0.2); }
        .chord-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .chord-tag { font-family: 'JetBrains Mono', monospace; font-weight: 600; padding: 8px 16px; border-radius: 20px; background: rgba(0, 255, 200, 0.1); border: 1px solid rgba(0, 255, 200, 0.3); color: var(--primary); }
        .progression { font-family: 'JetBrains Mono', monospace; font-size: 1.4rem; letter-spacing: 2px; color: var(--secondary); word-break: break-all; }
        .progression-chord { display: inline-block; margin: 4px; padding: 8px 12px; background: rgba(255, 107, 157, 0.15); border-radius: 8px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; }
        .stat-item { text-align: center; padding: 16px; background: rgba(0, 0, 0, 0.2); border-radius: 12px; }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 2rem; color: var(--primary); }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
        .key-display { font-family: 'JetBrains Mono', monospace; font-size: 1.2rem; color: var(--secondary); text-align: center; padding: 16px; background: rgba(255, 107, 157, 0.1); border-radius: 12px; margin-bottom: 16px; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 10, 15, 0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .loading-overlay.active { opacity: 1; pointer-events: all; }
        .spinner { width: 60px; height: 60px; border: 3px solid rgba(0, 255, 200, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: var(--text-muted); }
    </style>
</head>
<body>
    <header>
        <div class="logo">Chord<span>Scope</span></div>
        <p class="subtitle">Analizzatore di accordi ad alta precisione</p>
    </header>

    <div class="upload-zone" id="uploadZone">
        <p><strong>Trascina il file audio qui</strong></p>
        <p style="color: var(--text-muted); margin-top: 8px;">oppure clicca per selezionare</p>
        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 16px;">Formati: MP3, WAV (max 50MB)</p>
        <input type="file" class="file-input" id="fileInput" accept=".mp3,.wav,audio/mpeg,audio/wav">
    </div>

    <div class="results" id="results">
        <div class="section">
            <div class="key-display" id="keyDisplay">Tonalità: --</div>
            <div class="section-title">Statistiche</div>
            <div class="stats">
                <div class="stat-item"><div class="stat-value" id="totalChords">0</div><div class="stat-label">Accordi totali</div></div>
                <div class="stat-item"><div class="stat-value" id="uniqueChords">0</div><div class="stat-label">Accordi unici</div></div>
                <div class="stat-item"><div class="stat-value" id="duration">0:00</div><div class="stat-label">Durata brano</div></div>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Progressione Principale</div>
            <div class="progression" id="progression"></div>
        </div>
        <div class="section">
            <div class="section-title">Accordi Rilevati</div>
            <div class="chord-list" id="chordList"></div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;"><div class="spinner"></div><div class="loading-text" id="loadingText">Analisi in corso...</div></div>
    </div>

    <script>
        const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const KEY_PROFILES = {
            'C': [6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88],
            'G': [5.04, 2.24, 3.86, 2.06, 4.78, 4.03, 2.28, 5.52, 1.95, 2.84, 2.13, 2.78],
            'D': [4.09, 2.60, 3.04, 2.54, 4.70, 3.82, 2.41, 4.83, 2.66, 2.74, 1.92, 3.33],
            'A': [4.86, 2.17, 2.90, 2.65, 4.10, 3.97, 2.12, 4.51, 2.34, 2.88, 1.95, 2.97],
            'E': [4.26, 2.24, 2.83, 2.40, 4.16, 4.21, 2.12, 4.51, 2.22, 3.18, 2.08, 3.22],
            'F': [5.70, 2.28, 3.28, 2.18, 4.36, 3.94, 2.46, 4.94, 2.44, 3.24, 1.90, 2.74],
            'Bb': [4.96, 2.24, 2.96, 2.36, 4.30, 3.90, 2.20, 4.74, 2.28, 2.98, 2.00, 2.88],
            'Eb': [4.50, 2.56, 2.86, 2.44, 4.22, 3.92, 2.24, 4.56, 2.24, 3.12, 1.98, 3.18],
            'Ab': [4.18, 2.44, 2.90, 2.54, 4.06, 3.86, 2.30, 4.52, 2.30, 3.06, 2.04, 3.14],
            'Db': [4.06, 2.52, 2.82, 2.50, 4.12, 3.88, 2.26, 4.48, 2.28, 3.04, 2.02, 3.12],
            'Gb': [4.02, 2.60, 2.84, 2.58, 4.04, 3.82, 2.34, 4.46, 2.34, 2.98, 2.08, 3.08],
            'B': [3.94, 2.66, 2.80, 2.56, 4.04, 3.84, 2.34, 4.44, 2.26, 3.16, 1.88, 3.30],
            'Cm': [6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17],
            'Gm': [5.38, 2.84, 3.76, 5.14, 2.48, 3.70, 2.63, 4.75, 3.86, 2.24, 3.36, 2.82],
            'Dm': [5.22, 2.70, 3.46, 5.04, 2.64, 3.34, 2.22, 4.60, 3.72, 2.64, 2.84, 3.10],
            'Am': [5.12, 2.80, 3.30, 4.94, 2.56, 3.44, 2.34, 4.80, 3.72, 2.58, 3.06, 2.94],
            'Em': [5.28, 2.52, 3.52, 4.70, 2.70, 3.30, 2.30, 4.64, 3.86, 2.52, 2.90, 2.76],
            'Bm': [5.22, 2.58, 3.62, 4.78, 2.60, 3.36, 2.34, 4.68, 3.78, 2.46, 3.04, 2.72],
            'Fm': [5.86, 2.76, 3.40, 5.16, 2.52, 3.48, 2.64, 4.82, 3.80, 2.54, 3.26, 2.90],
            'Bbm': [5.44, 2.64, 3.44, 5.02, 2.58, 3.42, 2.56, 4.76, 3.78, 2.50, 3.18, 2.86],
            'Ebm': [5.30, 2.68, 3.44, 4.90, 2.56, 3.38, 2.42, 4.72, 3.80, 2.52, 3.04, 2.90],
            'Abm': [5.26, 2.72, 3.48, 4.82, 2.54, 3.40, 2.48, 4.68, 3.82, 2.54, 3.00, 2.82],
            'Dbm': [5.20, 2.70, 3.42, 4.76, 2.52, 3.38, 2.44, 4.66, 3.78, 2.52, 2.98, 2.84],
            'F#m': [5.28, 2.60, 3.56, 4.72, 2.58, 3.38, 2.38, 4.64, 3.76, 2.48, 3.02, 2.78],
            'C#m': [5.34, 2.64, 3.50, 5.00, 2.60, 3.40, 2.40, 4.70, 3.80, 2.50, 3.10, 2.84]
        };

        const CHORD_TEMPLATES = {
            'C': [1,0,0,0,1,0,0,1,0,0,0,0], 'Cm': [1,0,0,1,0,0,0,1,0,0,0,0],
            'D': [0,0,1,0,0,0,1,0,0,1,0,0], 'Dm': [0,0,1,0,0,1,0,0,0,1,0,0],
            'E': [0,0,0,0,1,0,0,0,1,0,0,1], 'Em': [0,0,0,0,1,0,0,1,0,0,0,1],
            'F': [1,0,0,0,0,1,0,0,0,1,0,0], 'Fm': [1,0,0,0,0,1,0,0,1,0,0,0],
            'G': [0,0,1,0,0,0,0,1,0,0,0,1], 'Gm': [0,0,1,0,0,0,0,1,0,0,1,0],
            'A': [0,1,0,0,1,0,0,0,0,1,0,0], 'Am': [1,0,0,0,1,0,0,0,0,1,0,0],
            'B': [0,0,0,1,0,0,1,0,0,0,0,1], 'Bm': [0,0,1,0,0,0,1,0,0,0,0,1],
            'Bb': [0,0,1,0,0,1,0,0,0,0,1,0], 'Bbm': [0,0,0,1,0,0,1,0,0,0,1,0],
            'Eb': [0,0,0,1,0,0,0,1,0,0,1,0], 'Ebm': [0,0,0,1,0,0,0,1,0,0,1,0],
            'Ab': [1,0,0,1,0,0,0,0,1,0,0,0], 'Abm': [0,0,0,1,0,0,0,0,1,0,0,1],
            'Db': [1,0,0,0,0,1,0,0,0,1,0,0], 'Dbm': [0,1,0,0,0,0,1,0,0,0,1,0],
            'F#': [0,1,0,0,0,0,1,0,0,0,1,0], 'F#m': [0,1,0,0,0,0,1,0,0,1,0,0],
            'C#': [0,1,0,0,0,1,0,0,1,0,0,0], 'C#m': [0,1,0,0,1,0,0,0,1,0,0,0],
            'G#': [1,0,0,1,0,0,0,0,1,0,0,0], 'G#m': [0,0,0,1,0,0,0,0,1,0,0,1],
            'D#': [0,0,0,1,0,0,0,1,0,0,1,0], 'D#m': [0,0,0,1,0,0,1,0,0,0,1,0],
            'A#': [0,0,1,0,0,1,0,0,0,0,1,0], 'A#m': [0,1,0,0,0,1,0,0,0,0,1,0],
            'G7': [0,0,1,0,0,0,0,1,0,0,0,1], 'C7': [1,0,0,0,1,0,0,1,0,0,0,1],
            'D7': [0,0,1,0,0,0,1,0,0,1,0,0], 'A7': [0,1,0,0,1,0,0,0,0,1,0,0],
            'E7': [0,0,0,0,1,0,0,1,0,0,1,0], 'B7': [0,0,1,0,0,1,0,0,0,0,1,0],
            'F7': [1,0,0,0,0,1,0,0,1,0,0,0], 'Bb7': [0,0,1,0,0,1,0,0,0,0,1,0],
            'Eb7': [0,0,0,1,0,0,0,1,0,0,1,0], 'Ab7': [1,0,0,1,0,0,0,0,1,0,0,0],
            'Db7': [1,0,0,0,0,1,0,0,0,1,0,0], 'Gb7': [0,1,0,0,0,0,1,0,0,0,1,0],
            'Cm7': [1,0,0,1,0,0,0,1,0,0,1,0], 'Dm7': [0,0,1,0,0,1,0,0,1,0,0,0],
            'Em7': [0,0,0,0,1,0,0,1,0,0,1,0], 'Fm7': [1,0,0,0,0,1,0,0,1,0,0,0],
            'Gm7': [0,0,1,0,0,0,0,1,0,0,1,0], 'Am7': [1,0,0,0,1,0,0,0,0,1,0,0],
            'Bm7': [0,0,1,0,0,0,1,0,0,0,0,1], 'Bbm7': [0,0,0,1,0,0,1,0,0,0,1,0],
            'Ebm7': [0,0,0,1,0,0,0,1,0,0,1,0], 'Abm7': [0,0,0,1,0,0,0,0,1,0,0,1],
            'Dbm7': [0,1,0,0,0,0,1,0,0,0,1,0], 'F#m7': [0,1,0,0,0,0,1,0,0,1,0,0],
            'C#m7': [0,1,0,0,1,0,0,0,1,0,0,0], 'G#m7': [0,0,0,1,0,0,0,0,1,0,0,1]
        };

        const DIATONIC = {
            'C': { major: ['C','Dm','Em','F','G','Am','Bdim'], minor: ['Cm','Ddim','Eb','Fm','Gm','Ab','Bb'] },
            'G': { major: ['G','Am','Bm','C','D','Em','F#dim'], minor: ['Gm','Adim','Bb','Cm','Dm','Eb','F'] },
            'D': { major: ['D','Em','F#m','G','A','Bm','C#dim'], minor: ['Dm','Edim','F','Gm','Am','Bb','C'] },
            'A': { major: ['A','Bm','C#m','D','E','F#m','G#dim'], minor: ['Am','Bdim','C','Dm','Em','F','G'] },
            'E': { major: ['E','F#m','G#m','A','B','C#m','D#dim'], minor: ['Em','F#dim','G','Am','Bm','C','D'] },
            'F': { major: ['F','Gm','Am','Bb','C','Dm','Edim'], minor: ['Fm','Gdim','Ab','Bbm','Cm','Db','Eb'] },
            'Bb': { major: ['Bb','Cm','Dm','Eb','F','Gm','Adim'], minor: ['Bbm','Cdim','Db','Ebm','Fm','Gb','Ab'] },
            'Eb': { major: ['Eb','Fm','Gm','Ab','Bb','Cm','Ddim'], minor: ['Ebm','Fdim','Gb','Abm','Bb','Cb','Db'] },
            'Ab': { major: ['Ab','Bbm','Cm','Db','Eb','Fm','Gdim'], minor: ['Abm','Bbdim','B','Cm','Dm','Eb','F'] },
            'Db': { major: ['Db','Ebm','Fm','Gb','Ab','Bbm','Cdim'], minor: ['Dbm','Edim','E','Fm','Gm','Ab','Bb'] },
            'Gb': { major: ['Gb','Abm','Bbm','Cb','Db','Ebm','Fdim'], minor: ['Gbm','Abdim','A','Bbm','Cm','Db','Eb'] },
            'B': { major: ['B','C#m','D#m','E','F#','G#m','A#dim'], minor: ['Bm','C#dim','D','Em','F#m','G','A'] },
            'F#': { major: ['F#','G#m','A#m','B','C#','D#m','E#dim'], minor: ['F#m','G#dim','A','Bm','C#m','D','E'] }
        };

        const KEY_ROOT = { 'C':0, 'C#':1, 'D':2, 'D#':3, 'E':4, 'F':5, 'F#':6, 'G':7, 'G#':8, 'A':9, 'A#':10, 'B':11 };

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingText = document.getElementById('loadingText');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.style.borderColor = 'var(--primary)'; });
        uploadZone.addEventListener('dragleave', () => { uploadZone.style.borderColor = ''; });
        uploadZone.addEventListener('drop', e => { e.preventDefault(); const f = e.dataTransfer.files[0]; if (f) handleFile(f); });
        fileInput.addEventListener('change', e => { const f = e.target.files[0]; if (f) handleFile(f); });

        function showLoading(t) { loadingText.textContent = t; loadingOverlay.classList.add('active'); }
        function hideLoading() { loadingOverlay.classList.remove('active'); }

        async function handleFile(file) {
            if (file.size > 50*1024*1024) { alert('File troppo grande'); return; }
            showLoading('Caricamento...');
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const buf = await ctx.decodeAudioData(await file.arrayBuffer());
                
                showLoading('Rilevamento tonalità...');
                const key = detectKey(buf);
                
                showLoading('Analisi accordi...');
                const chords = detectChords(buf, key);
                
                displayResults(chords, key, buf.duration);
                hideLoading();
            } catch(e) { hideLoading(); alert('Errore: '+e.message); }
        }

        function detectKey(buf) {
            const data = buf.getChannelData(0);
            const sr = buf.sampleRate;
            const fftSize = 16384;
            const hop = 8192;
            const chroma = new Array(12).fill(0);
            let n = 0;
            
            for (let i = 0; i < data.length - fftSize; i += hop) {
                const frame = data.slice(i, i + fftSize);
                const rms = Math.sqrt(frame.reduce((s,x) => s+x*x,0)/fftSize);
                if (rms < 0.02) continue;
                
                const c = computeChroma(frame, sr);
                for (let j = 0; j < 12; j++) chroma[j] += c[j];
                n++;
            }
            
            if (n === 0) return 'C';
            const max = Math.max(...chroma);
            if (max > 0) for (let i = 0; i < 12; i++) chroma[i] /= max;
            
            let bestKey = 'Gm', bestCorr = -Infinity;
            for (const [k, p] of Object.entries(KEY_PROFILES)) {
                const corr = pearson(chroma, p);
                if (corr > bestCorr) { bestCorr = corr; bestKey = k; }
            }
            return bestKey;
        }

        function pearson(x, y) {
            const n = x.length, sx = x.reduce((a,b)=>a+b,0), sy = y.reduce((a,b)=>a+b,0);
            const sxy = x.reduce((t,xi,i)=>t+xi*y[i],0), sx2 = x.reduce((t,x)=>t+x*x,0), sy2 = y.reduce((t,y)=>t+y*y,0);
            const num = n*sxy - sx*sy, den = Math.sqrt((n*sx2-sx*sx)*(n*sy2-sy*sy));
            return den === 0 ? 0 : num/den;
        }

        function detectChords(buf, key) {
            const data = buf.getChannelData(0);
            const sr = buf.sampleRate;
            const fftSize = 8192;
            const hop = 2048;
            
            const isMin = key.includes('m');
            const keyR = key.replace('m','');
            const diatonic = DIATONIC[keyR]?.[isMin ? 'minor' : 'major'] || [];
            
            const diatonicTemplates = {};
            diatonic.forEach(c => {
                if (CHORD_TEMPLATES[c]) diatonicTemplates[c] = CHORD_TEMPLATES[c];
            });
            
            const allTemplates = { ...diatonicTemplates };
            diatonic.forEach(c => {
                const root = c.replace(/m|dim|7$/g, '');
                ['7','m7'].forEach(suffix => {
                    const seventh = c.replace(/m|dim$/,'') + suffix;
                    if (CHORD_TEMPLATES[seventh]) allTemplates[seventh] = CHORD_TEMPLATES[seventh];
                });
            });

            const votes = {};
            Object.keys(allTemplates).forEach(c => votes[c] = 0);
            
            for (let i = 0; i < data.length - fftSize; i += hop) {
                const frame = data.slice(i, i + fftSize);
                const rms = Math.sqrt(frame.reduce((s,x)=>s+x*x,0)/fftSize);
                if (rms < 0.02) continue;
                
                const chroma = computeChroma(frame, sr);
                let best = 'N.C.', bestS = -Infinity;
                
                for (const [chord, tmpl] of Object.entries(allTemplates)) {
                    let score = 0;
                    for (let j = 0; j < 12; j++) if (tmpl[j]) score += chroma[j];
                    score /= tmpl.filter(x=>x).length;
                    
                    const root = chord.replace(/m|dim|7$/g,'');
                    const rootI = KEY_ROOT[root];
                    const keyI = KEY_ROOT[keyR];
                    const dist = Math.abs(rootI - keyI);
                    const dW = dist <= 2 ? 1.3 : dist <= 4 ? 1.0 : 0.6;
                    score *= dW;
                    
                    if (score > bestS) { bestS = score; best = chord; }
                }
                
                if (bestS > 0.15 && best !== 'N.C.') votes[best] = (votes[best] || 0) + 1;
            }

            const sorted = Object.entries(votes).sort((a,b) => b[1] - a[1]);
            const topChords = sorted.filter(x => x[1] > 0).slice(0, 8).map(x => x[0]);
            
            return topChords.map(c => ({ name: c, startTime: 0, endTime: 1 }));
        }

        function computeChroma(frame, sr) {
            const n = frame.length;
            const chroma = new Array(12).fill(0);
            
            const win = new Float32Array(n);
            for (let i = 0; i < n; i++) win[i] = 0.5 * (1 - Math.cos(2*Math.PI*i/(n-1)));
            
            const w = new Float32Array(n);
            for (let i = 0; i < n; i++) w[i] = frame[i] * win[i];
            
            const fft = fftSimple(w);
            const mag = new Float32Array(fft.length/2);
            for (let i = 0; i < mag.length; i++) mag[i] = Math.sqrt(fft[i].re*fft[i].re + fft[i].im*fft[i].im);
            
            const minBin = Math.floor(60*n/sr);
            const maxBin = Math.floor(1500*n/sr);
            
            for (let bin = minBin; bin < maxBin && bin < mag.length; bin++) {
                const freq = bin*sr/n;
                const note = 12*Math.log2(freq/440) + 69;
                const pc = Math.round(note) % 12;
                chroma[(pc+12)%12] += mag[bin];
            }
            
            const max = Math.max(...chroma);
            if (max > 0) for (let i = 0; i < 12; i++) chroma[i] /= max;
            return chroma;
        }

        function fftSimple(sig) {
            const n = sig.length;
            const f = new Array(n);
            for (let i = 0; i < n; i++) f[i] = { re: sig[i], im: 0 };
            const bits = Math.log2(n);
            for (let i = 0; i < n; i++) {
                const j = parseInt(i.toString(2).split('').reverse().join(''), 2);
                if (j > i) [f[i], f[j]] = [f[j], f[i]];
            }
            for (let size = 2; size <= n; size *= 2) {
                const half = size/2, ang = -2*Math.PI/size;
                const wr = Math.cos(ang), wi = Math.sin(ang);
                for (let i = 0; i < n; i += size) {
                    let cr = 1, ci = 0;
                    for (let j = 0; j < half; j++) {
                        const k = i+j, l = k+half;
                        const tr = cr*f[l].re - ci*f[l].im;
                        const ti = cr*f[l].im + ci*f[l].re;
                        f[l].re = f[k].re - tr; f[l].im = f[k].im - ti;
                        f[k].re += tr; f[k].im += ti;
                        const nr = cr*wr - ci*wi; ci = cr*wi + ci*wr; cr = nr;
                    }
                }
            }
            return f;
        }

        function displayResults(chords, key, dur) {
            uploadZone.classList.add('hidden');
            results.classList.add('active');
            document.getElementById('keyDisplay').textContent = `Tonalità: ${key}`;
            document.getElementById('totalChords').textContent = chords.length;
            document.getElementById('uniqueChords').textContent = chords.length;
            document.getElementById('duration').textContent = formatTime(dur);
            document.getElementById('chordList').innerHTML = chords.map(c => `<span class="chord-tag">${c.name}</span>`).join('');
            document.getElementById('progression').innerHTML = chords.map(c => `<span class="progression-chord">${c.name}</span>`).join(' → ');
        }

        function formatTime(s) { return `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`; }
    </script>
</body>
</html>
